{% extends "social/base.html" %}

{% block title %}Dashboard | Cortex{% endblock %}

{% block content %}

<div class="flex flex-col md:flex-row justify-between items-end mb-6 animate-fade-in-down">
    <div>
        <p class="text-xs font-bold text-indigo-500 dark:text-indigo-400 uppercase tracking-widest mb-1" id="portalDate"></p>
        <h1 class="text-3xl font-black text-gray-800 dark:text-white tracking-tight">
            Painel do Professor
        </h1>
    </div>
    <div class="mt-4 md:mt-0 flex gap-3">
        <a href="{{ url_for('planos.gerenciar_horario') }}" class="flex items-center px-4 py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-400 hover:text-indigo-600 transition-all text-xs font-bold uppercase tracking-wide">
            <i class="fas fa-cog mr-2"></i> Configurar Grade
        </a>
        <a href="{{ url_for('core.add_turma') }}" class="flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-md transition-all transform hover:-translate-y-0.5 text-xs font-bold uppercase tracking-wide">
            <i class="fas fa-plus mr-2"></i> Nova Turma
        </a>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <div class="lg:col-span-3 space-y-5">
        
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-5 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-600 opacity-10"></div>
            <div class="relative inline-block mt-2">
                {% if current_user.foto_perfil_path %}
                    <img class="h-16 w-16 rounded-xl object-cover border-2 border-white dark:border-gray-700 shadow-md mx-auto" 
                         src="{{ url_for('alunos.download_material', filename=current_user.foto_perfil_path) }}" alt="Perfil">
                {% else %}
                    <div class="h-16 w-16 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center text-xl font-bold mx-auto shadow-md">
                        {{ current_user.username[:2].upper() }}
                    </div>
                {% endif %}
            </div>
            <h3 class="mt-2 text-base font-bold text-gray-900 dark:text-white">{{ current_user.username }}</h3>
            <p class="text-[10px] text-gray-500 uppercase tracking-wide">{{ current_user.email_contato }}</p>
        </div>

        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden group">
            <button onclick="toggleCitySearch()" class="absolute top-3 right-3 text-blue-200 hover:text-white transition-colors z-20">
                <i class="fas fa-map-marker-alt"></i>
            </button>

            <div id="weatherDisplay" class="relative z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="weatherTemp" class="text-3xl font-bold">--°</h2>
                        <p id="cityName" class="text-xs font-medium text-blue-100 mt-1 truncate max-w-[120px]">Localizando...</p>
                    </div>
                    <i id="weatherIcon" class="fas fa-cloud-sun text-3xl text-blue-200 opacity-80"></i>
                </div>
                <div class="mt-4 grid grid-cols-3 gap-1 text-center border-t border-white/20 pt-2">
                    <div class="text-[10px]">
                        <span class="block opacity-70">09h</span>
                        <span id="forecast09" class="font-bold">--°</span>
                    </div>
                    <div class="text-[10px] border-l border-white/10">
                        <span class="block opacity-70">15h</span>
                        <span id="forecast15" class="font-bold">--°</span>
                    </div>
                    <div class="text-[10px] border-l border-white/10">
                        <span class="block opacity-70">20h</span>
                        <span id="forecast20" class="font-bold">--°</span>
                    </div>
                </div>
            </div>

            <div id="citySearchForm" class="hidden absolute inset-0 bg-blue-600 z-30 flex-col justify-center p-4">
                <p class="text-xs font-bold mb-2 uppercase text-blue-200">Definir Cidade:</p>
                <div class="flex gap-2">
                    <input type="text" id="cityInput" placeholder="Ex: São Paulo" 
                           class="w-full text-xs text-gray-800 rounded px-2 py-1 border-none focus:ring-2 focus:ring-white">
                    <button onclick="saveCity()" class="bg-white text-blue-600 rounded px-3 py-1 text-xs font-bold hover:bg-blue-50">OK</button>
                </div>
                <button onclick="toggleCitySearch()" class="text-[10px] text-blue-300 mt-2 hover:text-white underline text-center">Cancelar</button>
            </div>
            
            <i class="fas fa-wind absolute -bottom-2 -left-2 text-6xl text-white opacity-10"></i>
        </div>

        <nav class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
            <a href="{{ url_for('planos.planejamentos') }}" class="flex items-center justify-between px-4 py-3 border-b border-gray-50 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors group">
                <span class="text-xs font-bold text-gray-600 dark:text-gray-300 group-hover:text-indigo-600"><i class="fas fa-layer-group mr-2 w-4"></i> Planejamentos</span>
                <i class="fas fa-chevron-right text-[10px] text-gray-300 group-hover:text-indigo-400"></i>
            </a>
            <a href="{{ url_for('planos.diario_bordo') }}" class="flex items-center justify-between px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors group">
                <span class="text-xs font-bold text-gray-600 dark:text-gray-300 group-hover:text-teal-600"><i class="fas fa-book mr-2 w-4"></i> Diário de Bordo</span>
                <i class="fas fa-chevron-right text-[10px] text-gray-300 group-hover:text-teal-400"></i>
            </a>
        </nav>

        <div class="bg-emerald-50 dark:bg-emerald-900/10 rounded-xl p-3 border border-emerald-100 dark:border-emerald-900/20 flex items-center gap-3">
            <div class="bg-white dark:bg-emerald-900 p-2 rounded-lg text-center min-w-[40px] shadow-sm">
                <span id="holidayDay" class="block text-sm font-bold text-emerald-600 dark:text-emerald-400">--</span>
                <span id="holidayMonth" class="block text-[8px] uppercase font-bold text-emerald-400 dark:text-emerald-500">--</span>
            </div>
            <div class="overflow-hidden">
                <p id="holidayName" class="text-xs font-bold text-emerald-800 dark:text-emerald-200 truncate">Buscando...</p>
                <p class="text-[10px] text-emerald-600 dark:text-emerald-400">Próximo Feriado</p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
            <h2 class="text-xs font-bold text-gray-400 uppercase mb-3 flex justify-between">
                Lembretes
                <span class="bg-yellow-100 text-yellow-700 px-1.5 rounded">{{ lembretes|length }}</span>
            </h2>
            
            <form method="POST" action="{{ url_for('core.index') }}" class="mb-3 flex gap-1">
                {{ lembrete_form.hidden_tag() }}
                {{ lembrete_form.texto(placeholder="Nova nota...", class="w-full px-2 py-1 bg-gray-50 dark:bg-gray-900 border-0 rounded text-xs focus:ring-1 focus:ring-indigo-500 dark:text-white resize-none h-8", rows="1") }}
                <button type="submit" name="submit_lembrete" value="Salvar" class="bg-indigo-50 text-indigo-600 px-2 rounded hover:bg-indigo-100 transition-colors">
                    <i class="fas fa-plus text-xs"></i>
                </button>
            </form>

            <div class="space-y-1.5 max-h-[150px] overflow-y-auto custom-scrollbar">
                {% for lembrete in lembretes %}
                <div class="group flex items-start gap-2 text-[11px] p-1.5 rounded hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <form action="{{ url_for('core.concluir_lembrete', id=lembrete.id) }}" method="POST">
                        <button type="submit" class="text-gray-300 hover:text-green-500"><i class="far fa-square"></i></button>
                    </form>
                    <span class="flex-1 text-gray-600 dark:text-gray-400 break-words leading-tight">{{ lembrete.texto }}</span>
                    <form action="{{ url_for('core.deletar_lembrete', id=lembrete.id) }}" method="POST" class="invisible group-hover:visible">
                        <button type="submit" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </form>
                </div>
                {% else %}
                <p class="text-center text-[10px] text-gray-400 py-2">Vazio.</p>
                {% endfor %}
            </div>
        </div>

    </div>

    <div class="lg:col-span-9 space-y-6">
        
        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800">
                <h2 class="text-sm font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-indigo-500"></i> Grade Semanal
                </h2>
                <div class="flex items-center gap-2">
                    <span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] font-semibold text-gray-500 uppercase">Ativa</span>
                </div>
            </div>

            {% if blocos_map_widget %}
            <div class="overflow-x-auto">
                <table class="w-full text-xs border-collapse table-fixed min-w-[700px]">
                    <thead>
                        <tr class="bg-gray-50 dark:bg-gray-900/50 text-gray-500 dark:text-gray-400 uppercase text-[10px]">
                            <th class="w-16 py-2 border-r border-b border-gray-100 dark:border-gray-700 text-center bg-gray-50 dark:bg-gray-800 sticky left-0 z-10">Horário</th>
                            {% for dia in dias_semana_widget %}
                                <th class="py-2 border-b border-gray-100 dark:border-gray-700 text-center w-1/5">{{ dia[:3] }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                        {% for pos in range(1, 6) %}
                        <tr class="hover:bg-gray-50/50 dark:hover:bg-gray-700/20 transition-colors">
                            <td class="py-2 text-center font-bold text-gray-500 dark:text-gray-400 border-r border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 sticky left-0 z-10 text-[10px]">
                                {{ horarios_texto_widget[pos-1] }}
                            </td>
                            
                            {% for dia in range(5) %} 
                                {% set bloco = blocos_map_widget.get((dia, pos)) %}
                                <td class="p-1 relative h-14 align-top border-r border-dashed border-gray-100 dark:border-gray-700 last:border-0">
                                    {% if bloco %}
                                        {% if bloco.turma_bloco %}
                                            <a href="{{ url_for('alunos.turma', id_turma=bloco.turma_bloco.id) }}" 
                                               class="flex flex-col justify-center h-full w-full px-2 py-1 rounded bg-indigo-50 dark:bg-indigo-900/20 border-l-2 border-indigo-500 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-all">
                                                <span class="text-[10px] font-bold text-indigo-900 dark:text-indigo-200 truncate">
                                                    {{ bloco.turma_bloco.nome }}
                                                </span>
                                                {% if bloco.turma_bloco.descricao %}
                                                <span class="text-[9px] text-indigo-600 dark:text-indigo-400 truncate opacity-80">
                                                    {{ bloco.turma_bloco.descricao }}
                                                </span>
                                                {% endif %}
                                            </a>
                                        {% elif bloco.texto_alternativo %}
                                            <div class="flex items-center justify-center h-full w-full rounded bg-gray-100/50 dark:bg-gray-700/30 text-center">
                                                <span class="text-[10px] font-medium text-gray-500 dark:text-gray-400 truncate px-1">
                                                    {{ bloco.texto_alternativo }}
                                                </span>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-8 text-center">
                <p class="text-sm text-gray-400 mb-2">Grade horária não configurada.</p>
                <a href="{{ url_for('planos.gerenciar_horario') }}" class="text-indigo-600 text-xs font-bold hover:underline uppercase">Configurar</a>
            </div>
            {% endif %}
        </section>

        <section>
            <h2 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase mb-3 tracking-wide">Acesso Rápido</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for turma in turmas %}
                <a href="{{ url_for('alunos.turma', id_turma=turma.id) }}" 
                   class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-500 transition-all flex items-center p-3 gap-3 hover:shadow-md">
                    
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-sm shrink-0 bg-gradient-to-br 
                        {% if loop.index0 % 4 == 0 %} from-blue-500 to-blue-600
                        {% elif loop.index0 % 4 == 1 %} from-purple-500 to-pink-500
                        {% elif loop.index0 % 4 == 2 %} from-orange-400 to-red-500
                        {% else %} from-emerald-400 to-teal-500 {% endif %}">
                        {{ turma.nome[:2].upper() }}
                    </div>

                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-sm text-gray-800 dark:text-white truncate group-hover:text-indigo-600 dark:group-hover:text-indigo-400">
                            {{ turma.nome }}
                        </h3>
                        <div class="flex items-center gap-2 text-[10px] text-gray-500 dark:text-gray-400">
                            <span class="truncate">{{ turma.turno }}</span>
                            <span>•</span>
                            <span>{{ turma.alunos|length }} alunos</span>
                        </div>
                    </div>
                    
                    <i class="fas fa-chevron-right text-gray-300 text-xs group-hover:text-indigo-400"></i>
                </a>
                {% else %}
                <div class="col-span-full py-6 text-center border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg">
                    <p class="text-xs text-gray-400">Nenhuma turma encontrada.</p>
                </div>
                {% endfor %}
            </div>
        </section>

    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
    // 1. DATA ATUAL
    const dateEl = document.getElementById('portalDate');
    if(dateEl) {
        dateEl.textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
    }

    // 2. BRASIL API (FERIADOS)
    fetch(`https://brasilapi.com.br/api/feriados/v1/${new Date().getFullYear()}`)
        .then(res => res.json())
        .then(feriados => {
            const hoje = new Date();
            const proximo = feriados.find(f => new Date(f.date + "T00:00:00") >= hoje);
            if(proximo) {
                const dataF = new Date(proximo.date + "T00:00:00");
                document.getElementById('holidayDay').textContent = dataF.getDate();
                document.getElementById('holidayMonth').textContent = dataF.toLocaleString('pt-BR', { month: 'short' }).toUpperCase();
                document.getElementById('holidayName').textContent = proximo.name;
            } else {
                document.getElementById('holidayName').textContent = "Sem feriados previstos";
            }
        })
        .catch(() => document.getElementById('holidayName').textContent = "Erro ao carregar");

    // 3. CLIMA COM SELEÇÃO DE CIDADE
    // Elementos DOM
    const weatherWidget = {
        display: document.getElementById('weatherDisplay'),
        form: document.getElementById('citySearchForm'),
        input: document.getElementById('cityInput'),
        temp: document.getElementById('weatherTemp'),
        city: document.getElementById('cityName'),
        icon: document.getElementById('weatherIcon'),
        f09: document.getElementById('forecast09'),
        f15: document.getElementById('forecast15'),
        f20: document.getElementById('forecast20')
    };

    function toggleCitySearch() {
        weatherWidget.form.classList.toggle('hidden');
        weatherWidget.form.classList.toggle('flex');
        if(!weatherWidget.form.classList.contains('hidden')) {
            weatherWidget.input.focus();
        }
    }

    function saveCity() {
        const city = weatherWidget.input.value.trim();
        if(city) {
            localStorage.setItem('userCity', city);
            getWeatherForCity(city);
            toggleCitySearch();
        }
    }

    function updateUI(temp, cityName, code, hourly) {
        weatherWidget.temp.textContent = `${Math.round(temp)}°`;
        weatherWidget.city.textContent = cityName;
        
        // Ícones WMO
        if(code <= 3) weatherWidget.icon.className = "fas fa-cloud-sun text-3xl text-yellow-200";
        else if(code <= 67) weatherWidget.icon.className = "fas fa-cloud-rain text-3xl text-blue-200";
        else weatherWidget.icon.className = "fas fa-bolt text-3xl text-purple-200";

        // Previsões (Indices fixos aproximados para dia atual)
        const nowHour = new Date().getHours();
        // API Open-Meteo retorna array de horas começando 00:00 do dia
        weatherWidget.f09.textContent = `${Math.round(hourly[9])}°`;
        weatherWidget.f15.textContent = `${Math.round(hourly[15])}°`;
        weatherWidget.f20.textContent = `${Math.round(hourly[20])}°`;
    }

    function getWeatherForCity(city) {
        // 1. Geocoding
        fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=pt`)
            .then(res => res.json())
            .then(data => {
                if(data.results && data.results.length > 0) {
                    const { latitude, longitude, name } = data.results[0];
                    // 2. Weather
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&hourly=temperature_2m&timezone=auto`)
                        .then(res => res.json())
                        .then(weatherData => {
                            updateUI(
                                weatherData.current_weather.temperature, 
                                name, 
                                weatherData.current_weather.weathercode,
                                weatherData.hourly.temperature_2m
                            );
                        });
                } else {
                    alert('Cidade não encontrada!');
                }
            });
    }

    // Inicialização
    const savedCity = localStorage.getItem('userCity');
    if(savedCity) {
        getWeatherForCity(savedCity);
    } else {
        // Tenta geolocalização ou padrão
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    // Reverse Geo para pegar nome da cidade inicial
                    fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=pt`)
                        .then(res => res.json())
                        .then(data => {
                            const city = data.city || data.locality || "Brasília";
                            getWeatherForCity(city);
                        });
                },
                () => getWeatherForCity("Brasília")
            );
        } else {
            getWeatherForCity("Brasília");
        }
    }
</script>
{% endblock %}