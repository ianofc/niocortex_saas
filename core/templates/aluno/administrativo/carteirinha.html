{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carteirinha Digital | NioCortex</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;700;900&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/perfis.css' %}" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                        barcode: ['"Libre Barcode 39 Text"', 'cursive'],
                    },
                    colors: {
                        primary: 'var(--color-primary)',
                        secondary: 'var(--color-secondary)',
                        text: 'var(--text-main)',
                        textMuted: 'var(--text-muted)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos da Carteirinha */
        .id-card-container { perspective: 1000px; }
        .id-card {
            background: linear-gradient(135deg, #ffffff 0%, #f0f2f5 100%);
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative; overflow: hidden;
            -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
        }
        .holo-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(115deg, transparent 40%, rgba(255, 0, 255, 0.05) 45%, rgba(0, 255, 255, 0.05) 50%, transparent 55%);
            background-size: 200% 200%; pointer-events: none; z-index: 10;
            animation: holo-shimmer 4s infinite linear;
        }
        @keyframes holo-shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 6rem; font-weight: 900; color: rgba(0,0,0,0.04); pointer-events: none; white-space: nowrap; z-index: 0;
        }
        .qr-box { background: white; padding: 4px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        @media print {
            @page { size: auto; margin: 0mm; }
            body { background: white; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; }
            .glass-nav, .actions-bar, .holo-overlay, .fixed-background { display: none !important; }
            #printable-card { transform: scale(1) !important; box-shadow: none !important; border: 1px solid #ccc !important; }
        }
    </style>
</head>

<body x-data="appData({ gender: '{{ user.gender|default:'M' }}', is_premium: '{{ is_premium|yesno:'true,false' }}' })"
      x-init="init()"
      :class="theme"
      class="font-sans antialiased min-h-screen flex flex-col relative overflow-x-hidden selection:bg-[var(--color-primary)] selection:text-white"
      style="background-color: var(--bg-body); color: var(--text-main);">

    <div class="fixed inset-0 z-0 transition-colors duration-700 pointer-events-none fixed-background">
        <div class="absolute top-[-10%] left-[20%] w-[800px] h-[800px] rounded-full mix-blend-multiply filter blur-[120px] opacity-40 animate-float" :style="`background-color: var(--color-secondary)`"></div>
        <div class="absolute bottom-[10%] right-[10%] w-[600px] h-[600px] rounded-full mix-blend-multiply filter blur-[120px] opacity-40 animate-float" style="animation-delay: 2s; background-color: var(--color-primary)"></div>
        <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(var(--text-muted) 1px, transparent 1px); background-size: 30px 30px;"></div>
    </div>

    <nav class="sticky top-0 z-40 w-full px-4 py-2 transition-colors duration-300 shadow-sm glass-nav">
        <div class="flex items-center justify-between h-16 mx-auto max-w-7xl">
            <div class="flex items-center flex-1 gap-4">
                <a href="#" onclick="history.back()" class="flex items-center gap-3 group">
                    <div class="flex items-center justify-center w-10 h-10 text-lg font-bold text-white transition-transform shadow-lg rounded-xl group-hover:scale-110" style="background: var(--gradient-sidebar)">N</div>
                    <div class="flex flex-col justify-center">
                        <span class="hidden text-xl font-bold leading-none tracking-tight font-display md:block" style="color: var(--text-main)">Nio<span style="color: var(--color-primary)">Cortex</span></span>
                        <span class="text-[10px] uppercase font-bold tracking-widest opacity-60 hidden md:block" style="color: var(--text-muted)">
                            Identidade Digital
                        </span>
                    </div>
                </a>
            </div>
        </div>
    </nav>

    <main class="relative z-10 w-full p-4 pt-10 mx-auto max-w-4xl flex flex-col items-center justify-center min-h-[calc(100vh-80px)]">
        
        <div class="flex gap-4 mb-8 actions-bar print:hidden">
            <button onclick="history.back()" class="px-5 py-2.5 rounded-xl bg-white/70 backdrop-blur hover:bg-white transition text-sm font-bold shadow-sm border border-white/50 text-slate-600 flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button onclick="window.print()" class="px-5 py-2.5 rounded-xl bg-[var(--color-primary)] hover:opacity-90 transition text-sm font-bold shadow-lg shadow-[var(--color-primary)]/30 text-white flex items-center gap-2">
                <i class="fas fa-print"></i> Imprimir / PDF
            </button>
        </div>

        <div id="printable-card" class="id-card-container w-full max-w-[500px] aspect-[1.586/1]"> 
            <div class="id-card w-full h-full rounded-[16px] p-6 flex flex-col justify-between relative">
                
                <div class="holo-overlay print:hidden"></div>
                <div class="watermark font-display">VÁLIDO</div>

                <div class="relative z-20 flex items-start justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-[var(--color-primary)] to-[var(--color-secondary)] rounded-lg flex items-center justify-center text-white shadow-md print:bg-purple-600">
                            <i class="text-xl fas fa-university"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-extrabold leading-tight tracking-wide uppercase text-slate-800 font-display">
                                {{ escola.nome|default:"NioCortex Education" }}
                            </h1>
                            <p class="text-[10px] font-bold text-[var(--color-primary)] uppercase tracking-widest print:text-purple-700">
                                {% if "PROFESSOR" in user.role %}CARTEIRA FUNCIONAL{% else %}CARTEIRA DE ESTUDANTE{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="qr-box">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=User:{{ user.id }}-Valid:2026" class="object-contain w-16 h-16">
                    </div>
                </div>

                <div class="relative z-20 flex gap-5 mt-2">
                    <div class="flex flex-col items-center gap-1">
                        <div class="relative w-24 h-32 overflow-hidden bg-gray-200 border-2 border-white rounded-lg shadow-sm print:border-gray-300">
                            {% if user.avatar %}
                                <img src="{{ user.avatar.url }}" class="object-cover w-full h-full">
                            {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ user.first_name }}+{{ user.last_name }}&background=random&size=300" class="object-cover w-full h-full">
                            {% endif %}
                        </div>
                    </div>

                    <div class="flex flex-col justify-center flex-1 space-y-2">
                        <div>
                            <p class="text-[9px] uppercase text-slate-400 font-bold tracking-wider">Nome Completo</p>
                            <h2 class="text-xl font-black leading-tight truncate text-slate-800">{{ user.first_name }} {{ user.last_name }}</h2>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <p class="text-[9px] uppercase text-slate-400 font-bold tracking-wider">
                                    {% if "PROFESSOR" in user.role %}Função{% else %}Série{% endif %}
                                </p>
                                <p class="text-xs font-bold text-slate-700">
                                    {% if "PROFESSOR" in user.role %}
                                        DOCENTE
                                    {% else %}
                                        {{ aluno.turma.nome|default:"-" }}
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-[9px] uppercase text-slate-400 font-bold tracking-wider">Matrícula</p>
                                <p class="font-mono text-xs font-bold text-slate-700">#{{ user.id|stringformat:"06d" }}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <p class="text-[9px] uppercase text-slate-400 font-bold tracking-wider">Vínculo</p>
                                <p class="text-xs font-bold text-slate-700">Ativo</p>
                            </div>
                            <div>
                                <p class="text-[9px] uppercase text-slate-400 font-bold tracking-wider">Validade</p>
                                <p class="text-xs font-bold text-[var(--color-primary)] print:text-purple-700">31/12/{% now "Y" %}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative z-20 pt-2 mt-3 text-center border-t border-black/5">
                    <p class="text-4xl leading-none font-barcode text-slate-800 opacity-80">*{{ user.id }}*</p>
                    <p class="text-[8px] text-slate-400 font-mono mt-1">Documento de Identificação Institucional - Uso Pessoal e Intransferível</p>
                </div>

                <div class="absolute top-0 bottom-0 left-0 w-2 bg-gradient-to-b from-[var(--color-primary)] to-[var(--color-secondary)] print:bg-purple-600"></div>
            </div>
        </div>

        <div class="glass-panel p-6 rounded-2xl max-w-[500px] text-center mt-8 print:hidden bg-white/80 backdrop-blur border border-white/50">
            <h3 class="flex items-center justify-center gap-2 mb-2 font-bold text-slate-700">
                <i class="text-green-500 fas fa-check-circle"></i> Documento Válido
            </h3>
            <p class="text-xs leading-relaxed text-slate-500">
                Os dados apresentados são gerados em tempo real a partir do sistema NioCortex.
            </p>
        </div>

    </main>

    <script>
        function appData(data) {
            return {
                // Se gender for 'M', usa tema Azul. Se 'F', usa Rosa.
                // Se o user não tiver genero cadastrado, padrão é M (Azul/Aurora).
                theme: (data.gender === 'F') ? 'theme-pink' : 'theme-aurora', 
                
                init() {
                    console.log("Carteirinha Iniciada. Gênero:", data.gender);
                },
                setTheme(t) { this.theme = t; }
            }
        }
    </script>
</body>
</html>
