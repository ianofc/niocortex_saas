{% extends 'aluno/base_lumenios.html' %}

{% block content %}
<div class="max-w-[1600px] mx-auto px-6 space-y-8" 
     x-data="ziosResearch('{{ tema }}')" 
     x-init="startResearch()">

    <div class="relative overflow-hidden bg-slate-900 rounded-[3rem] p-10 shadow-2xl border border-slate-800">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
        <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-indigo-600/30 rounded-full blur-[120px] animate-pulse-slow"></div>
        
        <div class="relative z-10">
            <a href="{% url 'lumenios:dashboard_aluno' %}" class="inline-flex items-center gap-2 mb-6 text-xs font-bold tracking-widest text-indigo-400 uppercase transition hover:text-white">
                <i class="fas fa-arrow-left"></i> Retornar ao Dashboard
            </a>
            
            <div class="flex items-center gap-4 mb-2">
                <div class="flex items-center justify-center w-12 h-12 text-white bg-indigo-600 shadow-lg rounded-2xl shadow-indigo-500/50">
                    <i class="fas fa-brain"></i>
                </div>
                <h1 class="text-4xl font-bold text-white md:text-5xl font-display">
                    CONSCIOS
                </h1>
            </div>
            
            <p class="max-w-2xl text-lg text-slate-300">
                Gerando módulo de estudo personalizado sobre: <strong class="text-xl text-white border-b-2 border-pink-500">{{ tema }}</strong>
            </p>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
        
        <div class="space-y-8 lg:col-span-2">
            
            <div class="p-8 border bg-white/80 backdrop-blur-xl border-white/60 rounded-3xl shadow-glass">
                <div class="flex items-center gap-3 mb-6">
                    <i class="text-2xl text-indigo-600 fas fa-align-left"></i>
                    <h2 class="text-2xl font-bold text-slate-800">Conceito Fundamental</h2>
                </div>
                
                <div x-show="loading" class="space-y-4 animate-pulse">
                    <div class="w-full h-4 rounded bg-slate-200"></div>
                    <div class="w-5/6 h-4 rounded bg-slate-200"></div>
                    <div class="w-4/6 h-4 rounded bg-slate-200"></div>
                </div>

                <div x-show="!loading" class="animate-fade-in">
                    <p class="text-lg leading-relaxed text-slate-600" x-html="summary"></p>
                    
                    <div class="p-4 mt-6 border-l-4 border-indigo-500 bg-indigo-50 rounded-r-xl">
                        <h4 class="mb-1 text-sm font-bold text-indigo-900">Dica do Zios AI:</h4>
                        <p class="text-sm text-indigo-700">Este é um tópico frequente no ENEM e vestibulares. Foque nas definições básicas antes de avançar para os cálculos.</p>
                    </div>

                    <a :href="wikiLink" target="_blank" x-show="wikiLink" class="inline-flex items-center gap-2 mt-6 text-sm font-bold text-indigo-600 hover:text-indigo-800 hover:underline">
                        Ler artigo completo na Wikipedia <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>

            <div>
                <h3 class="flex items-center gap-2 mb-6 text-2xl font-bold text-slate-800">
                    <i class="text-red-500 fab fa-youtube"></i> Aulas Recomendadas
                </h3>
                
                <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                    <template x-for="video in videos">
                        <a :href="'https://www.youtube.com/watch?v=' + video.id.videoId" target="_blank" class="block overflow-hidden transition-all bg-white border shadow-sm group rounded-2xl border-slate-100 hover:shadow-lg hover:-translate-y-1">
                            <div class="relative aspect-video bg-slate-200">
                                <img :src="video.snippet.thumbnails.medium.url" class="object-cover w-full h-full">
                                <div class="absolute inset-0 flex items-center justify-center transition bg-black/30 group-hover:bg-black/10">
                                    <div class="flex items-center justify-center w-12 h-12 text-red-600 transition-transform bg-white rounded-full shadow-lg group-hover:scale-110">
                                        <i class="ml-1 fas fa-play"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4">
                                <h4 class="text-sm font-bold leading-tight text-slate-800 line-clamp-2" x-text="video.snippet.title"></h4>
                                <p class="mt-2 text-xs font-medium text-slate-500" x-text="video.snippet.channelTitle"></p>
                            </div>
                        </a>
                    </template>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            
            <div class="p-6 text-white bg-indigo-900 shadow-xl rounded-3xl">
                <h3 class="flex items-center gap-2 mb-4 font-bold text-white"><i class="fas fa-book"></i> Referências</h3>
                
                <div x-show="loadingBooks" class="h-20 bg-white/10 rounded-xl animate-pulse"></div>
                
                <div x-show="!loadingBooks" class="space-y-3">
                    <template x-for="book in books">
                        <a :href="book.link" target="_blank" class="flex items-start gap-3 p-3 transition border rounded-xl bg-white/10 hover:bg-white/20 border-white/5 hover:border-white/30">
                            <img :src="book.cover" class="object-cover w-10 rounded shadow-sm h-14 bg-slate-800" @error="$el.src='https://placehold.co/100x150?text=Livro'">
                            <div>
                                <h4 class="text-xs font-bold leading-tight text-white line-clamp-2" x-text="book.title"></h4>
                                <p class="text-[10px] text-indigo-200 mt-1 line-clamp-1" x-text="book.author"></p>
                            </div>
                        </a>
                    </template>
                </div>
                
                <a href="{% url 'lumenios:biblioteca' %}" class="block w-full py-3 mt-6 text-xs font-bold text-center text-indigo-900 transition bg-white shadow-lg rounded-xl hover:bg-indigo-50">
                    Pesquisar na Biblioteca
                </a>
            </div>

            <div class="p-6 border border-white bg-white/60 backdrop-blur-md rounded-3xl shadow-glass">
                <h3 class="mb-4 font-bold text-slate-800">Ações Rápidas</h3>
                <div class="space-y-2">
                    <button @click="openChat()" class="flex items-center w-full gap-3 p-3 text-left transition bg-white border rounded-xl border-slate-100 hover:border-indigo-300 hover:text-indigo-700 hover:shadow-md group">
                        <div class="flex items-center justify-center w-8 h-8 text-indigo-600 transition-colors rounded-lg bg-indigo-50 group-hover:bg-indigo-600 group-hover:text-white">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <span class="text-sm font-medium text-slate-600 group-hover:text-indigo-700">Tirar dúvida no Chat</span>
                    </button>
                    
                    <button class="flex items-center w-full gap-3 p-3 text-left transition bg-white border rounded-xl border-slate-100 hover:border-purple-300 hover:text-purple-700 hover:shadow-md group">
                        <div class="flex items-center justify-center w-8 h-8 text-purple-600 transition-colors rounded-lg bg-purple-50 group-hover:bg-purple-600 group-hover:text-white">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <span class="text-sm font-medium text-slate-600 group-hover:text-purple-700">Gerar Quiz (Em breve)</span>
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
function ziosResearch(theme) {
    return {
        query: theme,
        summary: '',
        wikiLink: '',
        videos: [],
        books: [],
        loading: true,
        loadingBooks: true,

        startResearch() {
            if (!this.query || this.query === 'None') {
                this.summary = "Selecione um tópico no Dashboard para iniciar.";
                this.loading = false;
                return;
            }
            
            this.fetchWiki();
            this.fetchVideos();
            this.fetchBooks();
        },

        async fetchWiki() {
            try {
                // Wikipedia API (Pública)
                const response = await fetch(`https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(this.query)}`);
                if (response.ok) {
                    const data = await response.json();
                    this.summary = data.extract_html || data.extract;
                    this.wikiLink = data.content_urls.desktop.page;
                } else {
                    this.summary = "Não encontramos um resumo direto na Wikipedia, mas reunimos os materiais abaixo para você.";
                }
            } catch (e) {
                this.summary = "Erro ao conectar com a base de conhecimento. Verifique sua conexão.";
            }
            this.loading = false;
        },

        async fetchVideos() {
            // OBS: Em produção, use sua API KEY do YouTube no Backend para não expor a chave
            // Aqui estamos usando uma simulação inteligente ou uma busca pública se possível
            // Para este exemplo, vou simular dados para garantir que a UI funcione sem Key
            
            // Simulação de resposta da API
            this.videos = [
                { id: { videoId: 'video1' }, snippet: { title: 'Aula Completa: ' + this.query, channelTitle: 'Canal Educação', thumbnails: { medium: { url: 'https://placehold.co/320x180/e2e8f0/64748b?text=Video+Aula' } } } },
                { id: { videoId: 'video2' }, snippet: { title: 'Resumão: Tudo sobre ' + this.query, channelTitle: 'Descomplica', thumbnails: { medium: { url: 'https://placehold.co/320x180/e2e8f0/64748b?text=Resumo' } } } },
            ];
        },

        async fetchBooks() {
            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(this.query)}&maxResults=3&langRestrict=pt`);
                const data = await response.json();
                
                if (data.items) {
                    this.books = data.items.map(item => ({
                        title: item.volumeInfo.title,
                        author: item.volumeInfo.authors ? item.volumeInfo.authors[0] : 'Desconhecido',
                        cover: item.volumeInfo.imageLinks ? item.volumeInfo.imageLinks.smallThumbnail : 'https://placehold.co/100x150?text=Capa',
                        link: item.volumeInfo.previewLink || item.volumeInfo.infoLink
                    }));
                }
            } catch (e) {
                console.error(e);
            }
            this.loadingBooks = false;
        },

        openChat() {
            // Dispara o widget global que já existe no base.html
            if (typeof toggleZios AI === 'function') {
                toggleZios AI();
                // Opcional: Pré-preencher o chat com o tema
                setTimeout(() => {
                    const input = document.getElementById('zios-input');
                    if(input) {
                        input.value = `Tenho uma dúvida sobre ${this.query}: `;
                        input.focus();
                    }
                }, 300);
            }
        }
    }
}
</script>
{% endblock %}