{% extends 'aluno/base_lumenios.html' %}

{% block content %}
<div class="max-w-[1600px] mx-auto px-6 space-y-12" 
     x-data="libraryEngine()" 
     x-init="initLibrary()">

    <div class="relative rounded-[3rem] overflow-hidden bg-slate-900 shadow-2xl p-10 md:p-14 min-h-[320px] flex flex-col justify-center group">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
        <div class="absolute top-0 right-0 w-[800px] h-[800px] bg-gradient-to-b from-indigo-600/40 via-purple-600/30 to-pink-600/20 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/3 animate-pulse-slow"></div>
        
        <div class="relative z-10 flex flex-col items-end justify-between gap-10 lg:flex-row">
            <div class="max-w-3xl space-y-5">
                <div class="flex flex-wrap gap-2">
                    <span class="px-3 py-1 text-[10px] font-bold tracking-widest text-teal-300 uppercase border rounded-full bg-teal-900/30 border-teal-500/30 backdrop-blur-md">
                        <i class="fas fa-check-circle"></i> Obras do Cânone
                    </span>
                    <span class="px-3 py-1 text-[10px] font-bold tracking-widest text-purple-300 uppercase border rounded-full bg-purple-900/30 border-purple-500/30 backdrop-blur-md">
                        <i class="fas fa-infinity"></i> Domínio Público
                    </span>
                </div>
                
                <h1 class="text-4xl font-bold leading-tight text-white md:text-6xl font-display drop-shadow-xl">
                    Biblioteca <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 via-purple-300 to-pink-300">Universal</span>
                </h1>
                <p class="max-w-2xl text-lg font-light leading-relaxed text-slate-300">
                    De <strong>Machado de Assis</strong> a <strong>Dostoiévski</strong>. Explore o acervo essencial para sua formação, incluindo livros didáticos, clássicos mundiais e teses acadêmicas.
                </p>
            </div>

            <div class="w-full lg:w-[500px] relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl blur opacity-30 group-hover:opacity-60 transition duration-500"></div>
                <div class="relative flex items-center h-16 overflow-hidden shadow-2xl bg-white/95 backdrop-blur-xl rounded-2xl ring-1 ring-white/50">
                    <div class="pl-6 text-indigo-500"><i class="text-xl fas fa-search"></i></div>
                    <input type="text" 
                           x-model="searchQuery" 
                           @keydown.enter="triggerSearch()"
                           placeholder="Ex: Dom Casmurro, Física Quântica, Orwell..." 
                           class="w-full h-full px-4 text-lg font-bold bg-transparent text-slate-800 focus:outline-none placeholder-slate-400">
                    <button @click="triggerSearch()" 
                            class="px-8 py-3 mr-2 font-bold text-white transition-all transform shadow-lg bg-slate-900 hover:bg-indigo-600 rounded-xl active:scale-95">
                        Buscar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="space-y-4">
        <div class="flex items-center gap-2 px-2">
            <i class="text-indigo-500 fas fa-compass"></i>
            <span class="text-xs font-bold tracking-wider uppercase text-slate-500">Coleções Essenciais</span>
        </div>
        <div class="flex flex-wrap gap-3 pb-4 border-b border-indigo-100/50">
            <template x-for="cat in curatedCategories">
                <button @click="loadCategory(cat)"
                        :class="currentCategory === cat.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/40 scale-105 ring-2 ring-indigo-300' : 'bg-white text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 border border-slate-200'"
                        class="px-6 py-3 rounded-xl font-bold text-sm transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                    <i :class="cat.icon"></i> <span x-text="cat.label"></span>
                </button>
            </template>
        </div>
    </div>

    <div class="min-h-[500px] relative">
        
        <div x-show="loading" class="grid grid-cols-2 gap-8 md:grid-cols-4 lg:grid-cols-6 animate-pulse">
            <template x-for="i in 12">
                <div class="space-y-4">
                    <div class="aspect-[2/3] bg-slate-200 rounded-2xl shadow-sm"></div>
                    <div class="w-3/4 h-4 rounded bg-slate-200"></div>
                    <div class="w-1/2 h-3 rounded bg-slate-200"></div>
                </div>
            </template>
        </div>

        <div x-show="!loading" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-x-6 gap-y-10">
            <template x-for="book in books" :key="book.id">
                <div class="relative cursor-pointer group perspective-1000" @click="openBook(book.link)">
                    
                    <div class="aspect-[2/3] rounded-xl relative shadow-[0_10px_30px_-10px_rgba(0,0,0,0.2)] group-hover:shadow-[0_20px_40px_-10px_rgba(99,102,241,0.3)] group-hover:-translate-y-3 transition-all duration-500 transform-style-3d bg-slate-100 overflow-hidden border border-white/60">
                        <img :src="book.cover" 
                             class="object-cover w-full h-full transition-transform duration-700 group-hover:scale-110"
                             @error="$el.src = generateCover(book.title)">
                        
                        <div class="absolute z-10 top-2 right-2">
                            <span class="px-2 py-1 text-[8px] font-black text-white rounded backdrop-blur-md shadow-sm uppercase tracking-wide border border-white/20"
                                  :class="book.isFree ? 'bg-emerald-500/90' : 'bg-indigo-500/90'">
                                <span x-text="book.isFree ? 'Grátis' : 'Amostra'"></span>
                            </span>
                        </div>

                        <div class="absolute inset-0 bg-gradient-to-t from-indigo-900/90 via-slate-900/40 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 flex flex-col items-center justify-end pb-6 backdrop-blur-[1px]">
                            <button class="px-6 py-2.5 bg-white text-indigo-900 rounded-full font-bold text-xs shadow-xl transform scale-90 group-hover:scale-100 transition-transform flex items-center gap-2 hover:bg-indigo-50">
                                <i class="fas fa-book-reader"></i> Ler Agora
                            </button>
                        </div>
                    </div>

                    <div class="px-1 mt-4">
                        <h3 class="text-sm font-bold leading-snug transition-colors text-slate-800 line-clamp-2 group-hover:text-indigo-600" x-text="book.title"></h3>
                        <p class="text-xs text-slate-500 mt-1.5 font-bold uppercase tracking-wide line-clamp-1" x-text="book.author"></p>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="!loading && books.length === 0" class="py-24 text-center bg-white border border-dashed border-slate-200 rounded-[3rem]">
            <div class="flex items-center justify-center w-20 h-20 mx-auto mb-4 text-3xl rounded-full bg-slate-50 text-slate-300">
                <i class="fas fa-search"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-700">Nenhum livro encontrado</h3>
            <p class="mt-2 text-slate-500">Tente buscar por outro título ou autor.</p>
        </div>

        <div class="flex justify-center mt-12 mb-8" x-show="books.length > 0">
            <button @click="loadMore()" 
                    :disabled="loadingMore"
                    class="flex items-center gap-2 px-10 py-3 font-bold transition-all bg-white border rounded-full group border-slate-200 text-slate-700 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-200 hover:shadow-xl disabled:opacity-50">
                <span x-show="!loadingMore">Carregar Mais</span>
                <span x-show="loadingMore"><i class="fas fa-spinner fa-spin"></i></span>
                <i class="text-xs transition-transform fas fa-chevron-down group-hover:translate-y-1" x-show="!loadingMore"></i>
            </button>
        </div>
    </div>

    <div class="pt-12 pb-12 border-t border-slate-200">
        <div class="flex flex-col justify-between gap-4 mb-8 md:flex-row md:items-end">
            <div>
                <span class="text-xs font-bold tracking-widest text-indigo-500 uppercase">Portal de Pesquisa</span>
                <h3 class="mt-1 text-3xl font-bold font-display text-slate-800">Acervos Nacionais & Internacionais</h3>
            </div>
            <p class="max-w-md text-sm text-right text-slate-500">Fontes oficiais para pesquisas aprofundadas, teses e documentos históricos.</p>
        </div>
        
        <div class="grid grid-cols-1 gap-5 md:grid-cols-2 lg:grid-cols-4">
            <a href="http://www.dominiopublico.gov.br/" target="_blank" class="p-5 transition border bg-gradient-to-br from-green-50 to-emerald-50 border-emerald-100 rounded-2xl hover:shadow-lg group">
                <div class="flex items-center gap-3 mb-2">
                    <div class="flex items-center justify-center w-10 h-10 text-xl rounded-lg bg-emerald-100 text-emerald-600"><i class="fas fa-university"></i></div>
                    <h4 class="font-bold text-slate-800">Domínio Público</h4>
                </div>
                <p class="text-xs leading-relaxed text-slate-600">A maior biblioteca virtual do governo brasileiro. Machado, Fernando Pessoa e muito mais.</p>
            </a>

            <a href="https://bndigital.bn.gov.br/" target="_blank" class="p-5 transition border border-blue-100 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl hover:shadow-lg group">
                <div class="flex items-center gap-3 mb-2">
                    <div class="flex items-center justify-center w-10 h-10 text-xl text-blue-600 bg-blue-100 rounded-lg"><i class="fas fa-landmark"></i></div>
                    <h4 class="font-bold text-slate-800">BNDigital</h4>
                </div>
                <p class="text-xs leading-relaxed text-slate-600">Acervo da Biblioteca Nacional. Mapas, manuscritos e obras raras do Brasil.</p>
            </a>

            <a href="https://www.gutenberg.org/" target="_blank" class="p-5 transition border border-orange-100 bg-gradient-to-br from-orange-50 to-amber-50 rounded-2xl hover:shadow-lg group">
                <div class="flex items-center gap-3 mb-2">
                    <div class="flex items-center justify-center w-10 h-10 text-xl text-orange-600 bg-orange-100 rounded-lg"><i class="fas fa-book-atlas"></i></div>
                    <h4 class="font-bold text-slate-800">Project Gutenberg</h4>
                </div>
                <p class="text-xs leading-relaxed text-slate-600">Mais de 60.000 e-books gratuitos. O pai de todas as bibliotecas digitais.</p>
            </a>

            <a href="https://scielo.org/" target="_blank" class="p-5 transition border border-purple-100 bg-gradient-to-br from-purple-50 to-fuchsia-50 rounded-2xl hover:shadow-lg group">
                <div class="flex items-center gap-3 mb-2">
                    <div class="flex items-center justify-center w-10 h-10 text-xl text-purple-600 bg-purple-100 rounded-lg"><i class="fas fa-atom"></i></div>
                    <h4 class="font-bold text-slate-800">SciELO</h4>
                </div>
                <p class="text-xs leading-relaxed text-slate-600">Periódicos e artigos científicos para pesquisas acadêmicas sérias.</p>
            </a>

            <a href="https://digital.bbm.usp.br/handle/bbm/1" target="_blank" class="p-5 transition bg-white border border-slate-200 rounded-2xl hover:border-indigo-300 hover:shadow-md">
                <h4 class="mb-1 text-sm font-bold text-indigo-700"><i class="mr-1 fas fa-external-link-alt"></i> USP Brasiliana</h4>
                <p class="text-[10px] text-slate-500">Acervo Guita e José Mindlin. História do Brasil.</p>
            </a>

            <a href="https://www2.senado.leg.br/bdsf/" target="_blank" class="p-5 transition bg-white border border-slate-200 rounded-2xl hover:border-indigo-300 hover:shadow-md">
                <h4 class="mb-1 text-sm font-bold text-indigo-700"><i class="mr-1 fas fa-gavel"></i> Biblioteca do Senado</h4>
                <p class="text-[10px] text-slate-500">História política, leis e obras raras.</p>
            </a>

            <a href="https://openlibrary.org/" target="_blank" class="p-5 transition bg-white border border-slate-200 rounded-2xl hover:border-indigo-300 hover:shadow-md">
                <h4 class="mb-1 text-sm font-bold text-indigo-700"><i class="mr-1 fas fa-globe"></i> Open Library</h4>
                <p class="text-[10px] text-slate-500">Um livro web para cada livro físico já publicado.</p>
            </a>

            <a href="http://machado.mec.gov.br/" target="_blank" class="p-5 transition bg-white border border-slate-200 rounded-2xl hover:border-indigo-300 hover:shadow-md">
                <h4 class="mb-1 text-sm font-bold text-indigo-700"><i class="mr-1 fas fa-feather-alt"></i> Machadiana</h4>
                <p class="text-[10px] text-slate-500">Obra completa de Machado de Assis (MEC).</p>
            </a>
        </div>
    </div>

</div>

<script>
    function libraryEngine() {
        return {
            searchQuery: '',
            books: [],
            loading: false,
            loadingMore: false,
            startIndex: 0,
            currentCategory: 'classicos_br',
            
            // AS LISTAS ESSENCIAIS (Baseadas no seu prompt)
            curatedCategories: [
                { 
                    id: 'classicos_br', 
                    label: 'Clássicos Brasileiros', 
                    icon: 'fas fa-feather',
                    // A nata da literatura nacional
                    queries: ['Machado de Assis Dom Casmurro', 'Vidas Secas Graciliano Ramos', 'Grande Sertão Veredas', 'A Hora da Estrela Clarice Lispector', 'O Cortiço Aluísio Azevedo', 'Triste Fim de Policarpo Quaresma', 'Capitães da Areia Jorge Amado', 'Memórias Póstumas de Brás Cubas', 'O Tempo e o Vento', 'Morte e Vida Severina'] 
                },
                { 
                    id: 'canone_mundial', 
                    label: 'Cânone Mundial', 
                    icon: 'fas fa-globe',
                    // Os gigantes da literatura universal
                    queries: ['Dom Quixote Cervantes', 'Crime e Castigo Dostoiévski', '1984 George Orwell', 'Cem Anos de Solidão', 'A Divina Comédia Dante', 'Orgulho e Preconceito Jane Austen', 'O Pequeno Príncipe', 'A Metamorfose Kafka', 'Hamlet Shakespeare', 'Os Miseráveis Victor Hugo'] 
                },
                { 
                    id: 'poesia_br', 
                    label: 'Poesia & Modernismo', 
                    icon: 'fas fa-pen-fancy',
                    // Poetas e Modernistas
                    queries: ['Carlos Drummond de Andrade poesia', 'Cecília Meireles', 'Castro Alves Espumas Flutuantes', 'Macunaíma Mário de Andrade', 'Manuel Bandeira', 'Vinicius de Moraes', 'João Cabral de Melo Neto'] 
                },
                { 
                    id: 'infanto', 
                    label: 'Infanto-Juvenil', 
                    icon: 'fas fa-child',
                    // Formação de leitores
                    queries: ['Meu Pé de Laranja Lima', 'O Menino Maluquinho', 'Sítio do Picapau Amarelo Monteiro Lobato', 'Turma da Mônica', 'Harry Potter', 'O Hobbit', 'Alice no País das Maravilhas', 'As Crônicas de Nárnia'] 
                },
                { 
                    id: 'didaticos', 
                    label: 'Apoio Escolar & Didáticos', 
                    icon: 'fas fa-graduation-cap',
                    // Material para estudo
                    queries: ['Matemática Ensino Médio', 'Física Mecânica', 'Química Tabela Periódica', 'Geografia do Brasil', 'História do Brasil', 'Biologia Celular', 'Gramática Portuguesa', 'Redação ENEM'] 
                },
                { 
                    id: 'pensamento', 
                    label: 'Filosofia & Sociologia', 
                    icon: 'fas fa-brain',
                    // Para pensar
                    queries: ['A República Platão', 'O Príncipe Maquiavel', 'Sapiens Yuval Harari', 'O Segundo Sexo Simone de Beauvoir', 'Casa Grande e Senzala', 'Raízes do Brasil'] 
                }
            ],

            initLibrary() {
                // Inicia com os Clássicos Brasileiros
                this.loadCategory(this.curatedCategories[0]);
            },

            triggerSearch() {
                if(!this.searchQuery) return;
                this.currentCategory = 'search';
                this.books = [];
                this.startIndex = 0;
                this.searchSingleQuery(this.searchQuery);
            },

            loadCategory(category) {
                this.currentCategory = category.id;
                this.searchQuery = ''; 
                this.books = []; 
                this.startIndex = 0;
                
                // MODO MIXAGEM INTELIGENTE
                // Pega 4 termos aleatórios da lista curada para garantir variedade a cada clique
                const shuffled = category.queries.sort(() => 0.5 - Math.random());
                const selectedTerms = shuffled.slice(0, 5); 
                
                this.searchMixedQuery(selectedTerms);
            },

            loadMore() {
                this.loadingMore = true;
                this.startIndex += 20;

                if (this.currentCategory === 'search') {
                    this.searchSingleQuery(this.searchQuery, true);
                } else {
                    // Se estiver em uma categoria, pega mais um termo aleatório da lista para adicionar
                    const cat = this.curatedCategories.find(c => c.id === this.currentCategory);
                    const randomTerm = cat.queries[Math.floor(Math.random() * cat.queries.length)];
                    this.searchSingleQuery(randomTerm, true);
                }
                
                this.loadingMore = false;
            },

            // --- ENGINE DE BUSCA ---

            async searchMixedQuery(terms) {
                this.loading = true;
                try {
                    // Busca paralela de vários termos específicos
                    const promises = terms.map(term => 
                        fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(term)}&maxResults=6&langRestrict=pt&orderBy=relevance`)
                            .then(res => res.json())
                    );

                    const results = await Promise.all(promises);
                    let mixedBooks = [];

                    results.forEach(data => {
                        if (data.items) {
                            const mapped = data.items.map(this.normalizeBook);
                            mixedBooks = [...mixedBooks, ...mapped];
                        }
                    });

                    // Remove duplicatas (pelo ID do Google)
                    mixedBooks = mixedBooks.filter((v,i,a)=>a.findIndex(v2=>(v2.id===v.id))===i);
                    // Embaralha para não parecer blocos
                    this.books = mixedBooks.sort(() => 0.5 - Math.random());

                } catch (e) {
                    console.error(e);
                } finally {
                    this.loading = false;
                }
            },

            async searchSingleQuery(query, append = false) {
                if (!append) this.loading = true;
                try {
                    const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=20&startIndex=${this.startIndex}&langRestrict=pt`;
                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.items) {
                        const newBooks = data.items.map(this.normalizeBook);
                        if (append) {
                            this.books = [...this.books, ...newBooks];
                        } else {
                            this.books = newBooks;
                        }
                    }
                } catch (e) {
                    console.error(e);
                } finally {
                    this.loading = false;
                    this.loadingMore = false;
                }
            },

            normalizeBook(item) {
                const info = item.volumeInfo;
                const access = item.accessInfo;
                
                let cover = 'https://placehold.co/300x450/f1f5f9/94a3b8?text=Sem+Capa';
                if (info.imageLinks) {
                    cover = info.imageLinks.thumbnail || info.imageLinks.smallThumbnail;
                    cover = cover.replace('http:', 'https:');
                }

                // Lógica para determinar se é "Grátis" ou "Amostra"
                const isFree = access.viewability !== 'NO_PAGES' && (item.saleInfo.saleability === 'FREE' || access.accessViewStatus === 'FULL_PUBLIC_DOMAIN');

                return {
                    id: item.id,
                    title: info.title || 'Título Desconhecido',
                    author: info.authors ? info.authors[0] : 'Autor Desconhecido',
                    cover: cover,
                    link: access.webReaderLink || info.previewLink || info.infoLink,
                    isFree: isFree
                };
            },

            generateCover(title) {
                return `https://placehold.co/300x450/f8fafc/64748b?text=${encodeURIComponent(title.substring(0,20))}`;
            },

            openBook(link) {
                window.open(link, '_blank');
            }
        }
    }
</script>
{% endblock %}