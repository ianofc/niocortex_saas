{% load static %}

<div class="mb-6 overflow-hidden transition-all bg-white border border-gray-100 shadow-sm rounded-2xl hover:shadow-md" id="post-{{ post.id }}">
    
    <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center space-x-3">
            {% if not post.is_system_event %}
                <a href="{% url 'yourlife_social:profile_detail' post.autor.username %}" class="relative cursor-pointer group">
            {% else %}
                <div class="relative cursor-default group">
            {% endif %}
            
                <div class="w-10 h-10 rounded-full p-[2px] bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500">
                    <div class="w-full h-full overflow-hidden bg-white border-2 border-white rounded-full">
                        {% if post.autor.avatar %}
                            <img src="{{ post.autor.avatar.url }}" class="object-cover w-full h-full">
                        {% else %}
                            <div class="flex items-center justify-center w-full h-full text-xs font-bold text-gray-500 bg-gray-200">
                                {{ post.autor.first_name|first }}
                            </div>
                        {% endif %}
                    </div>
                </div>

            {% if not post.is_system_event %}
                </a>
            {% else %}
                </div>
            {% endif %}

            <div class="leading-tight">
                <div class="flex items-center">
                    {% if not post.is_system_event %}
                        <a href="{% url 'yourlife_social:profile_detail' post.autor.username %}" class="text-sm font-bold text-slate-900 hover:underline decoration-indigo-500">
                            {{ post.autor.username }}
                        </a>
                    {% else %}
                        <span class="text-sm font-bold text-slate-900">{{ post.autor.username }}</span>
                    {% endif %}
                    
                    {% if post.location %}
                        <span class="mx-1 text-gray-400">•</span>
                        <span class="text-xs text-gray-500">{{ post.location }}</span>
                    {% endif %}
                </div>
                <p class="text-[11px] text-gray-400">{{ post.data_criacao|timesince }} atrás</p>
            </div>
        </div>

        {% if not post.is_system_event %}
        <button class="p-2 text-gray-400 transition-colors rounded-full hover:bg-gray-100">
            <i class="fas fa-ellipsis-h"></i>
        </button>
        {% endif %}
    </div>

    {% if post.conteudo %}
    <div class="px-4 pb-3">
        <p class="text-[15px] leading-relaxed text-slate-800 whitespace-pre-line font-normal">
            {{ post.conteudo|truncatechars:280 }}
            {% if post.conteudo|length > 280 %}
                <button class="ml-1 text-sm font-semibold text-indigo-600 hover:underline">ler mais</button>
            {% endif %}
        </p>
    </div>
    {% endif %}

    {% if post.imagem %}
    <div class="relative flex items-center justify-center w-full overflow-hidden border-t border-b border-gray-100 bg-gray-50">
        <img src="{% if post.is_system_event %}{{ post.imagem }}{% else %}{{ post.imagem.url }}{% endif %}" 
             class="w-full h-auto object-cover max-h-[600px]" 
             loading="lazy" 
             alt="Post content">
    </div>
    {% endif %}

    {% if post.video %}
    <div class="w-full bg-black">
        <video controls class="w-full max-h-[600px]">
             <source src="{% if post.is_system_event %}{{ post.video }}{% else %}{{ post.video.url }}{% endif %}" type="video/mp4">
        </video>
    </div>
    {% endif %}

    <div class="flex items-center justify-between px-4 py-2 text-xs text-gray-500 border-b border-gray-50">
        <div class="flex items-center space-x-1">
            {% if post.total_likes > 0 %}
                <div class="flex mr-2 -space-x-1">
                    <div class="w-4 h-4 bg-red-500 border border-white rounded-full"></div>
                    <div class="w-4 h-4 bg-blue-500 border border-white rounded-full"></div>
                </div>
                <span class="font-semibold text-slate-700" id="likes-val-{{ post.id }}">{{ post.total_likes }} curtidas</span>
            {% else %}
                <span id="likes-val-{{ post.id }}">Seja o primeiro a curtir</span>
            {% endif %}
        </div>
        
        {% if post.total_comentarios > 0 %}
            <button class="transition hover:text-slate-800">{{ post.total_comentarios }} comentários</button>
        {% endif %}
    </div>

    <div class="flex items-center justify-between px-2 py-1">
        
        <div class="flex items-center flex-1 space-x-1">
            
            {% if not post.is_system_event %}
            <button hx-post="{% url 'yourlife_social:toggle_like' post.id %}" 
                    hx-swap="outerHTML" 
                    hx-target="#like-btn-{{ post.id }}" 
                    id="like-btn-{{ post.id }}" 
                    class="flex items-center justify-center flex-1 py-2 space-x-2 transition-all rounded-lg hover:bg-gray-50 group active:scale-95">
                {% if post.user_liked %}
                    <i class="text-lg text-red-500 transition-transform duration-300 scale-110 fas fa-heart"></i>
                    <span class="text-xs font-bold text-red-500">Curtiu</span>
                {% else %}
                    <i class="text-lg transition-colors far fa-heart text-slate-600 group-hover:text-red-500"></i>
                    <span class="text-xs font-semibold transition-colors text-slate-600 group-hover:text-red-500">Curtir</span>
                {% endif %}
            </button>
            {% else %}
            <button class="flex items-center justify-center flex-1 py-2 space-x-2 transition-all rounded-lg cursor-default hover:bg-gray-50 opacity-60">
                <i class="text-lg far fa-heart text-slate-400"></i>
                <span class="text-xs font-semibold text-slate-400">Curtir</span>
            </button>
            {% endif %}

            <button onclick="document.getElementById('comment-input-{{ post.id }}').focus()" 
                    class="flex items-center justify-center flex-1 py-2 space-x-2 transition-all rounded-lg hover:bg-gray-50 group active:scale-95">
                <i class="text-lg transition-colors far fa-comment text-slate-600 group-hover:text-blue-500"></i>
                <span class="text-xs font-semibold transition-colors text-slate-600 group-hover:text-blue-500">Comentar</span>
            </button>

            <button class="flex items-center justify-center flex-1 py-2 space-x-2 transition-all rounded-lg hover:bg-gray-50 group active:scale-95">
                <i class="text-lg transition-colors far fa-paper-plane text-slate-600 group-hover:text-green-500"></i>
                <span class="text-xs font-semibold transition-colors text-slate-600 group-hover:text-green-500">Enviar</span>
            </button>
        </div>

        {% if not post.is_system_event %}
        <button class="p-2 transition-colors rounded-full hover:bg-gray-50 text-slate-600 hover:text-yellow-500">
            <i class="text-lg far fa-bookmark"></i>
        </button>
        {% endif %}
    </div>

    {% if not post.is_system_event %}
    <div class="px-4 py-3 border-t border-gray-100 bg-gray-50/30">
        <form hx-post="{% url 'yourlife_social:add_comment' post.id %}" 
              hx-swap="none" 
              hx-on::after-request="this.reset()" 
              class="flex items-center gap-3">
            
            {% if request.user.avatar %}
                <img src="{{ request.user.avatar.url }}" class="w-8 h-8 border border-gray-200 rounded-full">
            {% else %}
                <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-600">
                    {{ request.user.first_name|first }}
                </div>
            {% endif %}

            <div class="relative flex-1">
                <input type="text" 
                       name="conteudo" 
                       id="comment-input-{{ post.id }}" 
                       placeholder="Adicione um comentário..." 
                       class="w-full px-4 py-2 text-xs placeholder-gray-400 transition-all bg-gray-100 border-none rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:bg-white text-slate-700"
                       required 
                       autocomplete="off">
                <button type="button" class="absolute text-gray-400 transition right-3 top-2 hover:text-yellow-500">
                    <i class="far fa-smile"></i>
                </button>
            </div>
        </form>
    </div>
    {% endif %}

</div>